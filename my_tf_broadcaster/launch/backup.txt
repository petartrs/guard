#!/usr/bin/env python3

import rospy
import tf2_ros
from geometry_msgs.msg import PoseStamped, TransformStamped, Vector3Stamped

def instance2_pose_callback(msg):
    # You can process the pose message here if needed, but you don't need to publish it.
    rospy.loginfo("Received /instance2/pose: %s", msg.pose)


def main():
    rospy.init_node('broadcast_tf_as_vector')
    tfBuffer = tf2_ros.Buffer()
    listener = tf2_ros.TransformListener(tfBuffer)
    vector_pub = rospy.Publisher('tf_vector', Vector3Stamped, queue_size=10)
    
     # Subscribe to the /instance1/pose/ and instance2/pose topics
    rospy.Subscriber('/instance2/pose', PoseStamped, instance2_pose_callback)
    rospy.Subscriber('/instance1/pose', PoseStamped, instance2_pose_callback)
  
    
    rate = rospy.Rate(10.0)  # 10 Hz

    while not rospy.is_shutdown():
        try:
            transformStamped = tfBuffer.lookup_transform('imu_flat_yaw', 'aruco_26', rospy.Time(0))
            vector_msg = Vector3Stamped()
            vector_msg.header.stamp = rospy.Time.now()
            vector_msg.header.frame_id = 'imu_flat_yaw'
            # multiply by 10 to transform from metres to dm
            vector_msg.vector.x = transformStamped.transform.translation.x*10
            vector_msg.vector.y = transformStamped.transform.translation.y*10
            vector_msg.vector.z = transformStamped.transform.translation.z*10
            vector_pub.publish(vector_msg)
        except (tf2_ros.LookupException, tf2_ros.ConnectivityException, tf2_ros.ExtrapolationException) as e:
            rospy.logwarn(e)
            rospy.sleep(1.0)
            continue
        rate.sleep()

if __name__ == '__main__':
    try:
        main()
    except rospy.ROSInterruptException:
        pass

